# interlok-aws-interop [![Actions Status](https://github.com/adaptris-labs/interlok-aws-interop/workflows/verifyInterlokConfig/badge.svg)](https://github.com/adaptris-labs/interlok-aws-interop/actions)

Interlok configuration that has six workflows:

* Workflow that exposes HTTP endpoint `/api/kinesis` which will produce to kinesis stream `myStream`
* Workflow that exposes `/api/s3/..` REST style operations
* Workflow that exposes `/api/s3utils/...` for everything not covered in s3 REST workflow
* Workflow that exposes `/api/sns/...` which will produce a notification to sns topic `interlok`
* Workflow that listen on a sqs queue `interlok` and will add the content to a file in s3
* Workflow that exposes HTTP endpoint `/api/kms` to encrypt/decrypt content and sign content and verify signatures

Inspired by this blog post: [Testing Interlok interoperability with AWS](https://interlok.adaptris.net/blog/2019/08/30/interlok-interop-with-aws.html)

## Setup

```shell
# start localstack
docker-compose up -d
# build interlok
gradle clean install
# start interlok
cd ./build/distribution
java -jar ./lib/interlok-boot.jar
```

## Testing

### Kinesis

```shell
# Follow kinesis stream iterator logs
docker-compose logs -f localstack
curl -X POST http://localhost:8080/api/kinesis -d '{ "key" : "value" }'
```

### S3

```shell
# Upload File
curl -X POST -H "Content-Type: application/json" -d '{"key": "value"}' "http://localhost:8080/api/s3/file.txt"
# List Files
curl "http://localhost:8080/api/s3/"
# Get File
curl "http://localhost:8080/api/s3/file.txt"
# Get File (use download)
curl "http://localhost:8080/api/s3/file.txt?useDownload=true"
# Delete File
curl -X DELETE "http://localhost:8080/api/s3/file.txt"
# Copy File
curl "http://localhost:8080/api/s3utils/copy?from=file.txt&to=other.txt"
# Extended Copy File (adds Content-Disposition) - Works directly with AWS but may not work with localstack
curl "http://localhost:8080/api/s3utils/copy-extended?from=file.txt&to=other.txt"
# Tag a file
curl "http://localhost:8080/api/s3utils/tag?key=file.txt&tags_hello=world"
# Get Tags
curl "http://localhost:8080/api/s3utils/tag-get?key=file.txt"
# Check File Exists
curl "http://localhost:8080/api/s3utils/check-file-exists?key=nothere.txt"
```

### S3 With STS

```shell
# Upload File
curl -X POST -H "Content-Type: application/json" -d '{"key": "value"}' "http://localhost:8080/api/s3-sts/file.txt"
# List Files
curl "http://localhost:8080/api/s3-sts/"
# Get File
curl "http://localhost:8080/api/s3-sts/file.txt"
# Get File (use download)
curl "http://localhost:8080/api/s3-sts/file.txt?useDownload=true"
# Delete File
curl -X DELETE "http://localhost:8080/api/s3-sts/file.txt"
```

### S3 - Retry Message Store

```shell
curl -si -XPOST -d"Hello World" http://localhost:8080/api/always-fail
curl -si -XGET http://localhost:8080/api/failed/list
curl -si -XPOST http://localhost:8080/api/retry/ec24c442-e688-45cc-b6db-24bd6893cf4e
curl -si -XDELETE http://localhost:8080/api/failed/delete/ec24c442-e688-45cc-b6db-24bd6893cf4e
```

### SNS and SQS

The instance of localstack generated by docker compose has a SNS subscription that forward message from the SNS topic `interlok` to the SQS queue `interlok`.

```shell
curl -X POST http://localhost:8080/api/sns -d '{ "key" : "value" }'
# Then check that a new file exist in s3. It can takes a few seconds to appear in the s3 bucket.
curl "http://localhost:8080/api/s3/"
```

### KMS

```shell
# Encrypt content. The result is base64 encoded
curl -X POST -d 'Hello World' "http://localhost:8080/api/kms/encrypt"
# Decrypt base64 encoded encrypted content
curl -X POST -d 'base64 encoded encrypted content (result from /api/kms/encrypt)' "http://localhost:8080/api/kms/decrypt"
# Sign. The result is base64 encoded
curl -X POST -d 'Hello World' "http://localhost:8080/api/kms/sign"
# Verify signatures
curl -X POST -H "Content-Type: application/json" -d '{"signature":"base64 encoded signature (result from /api/kms/sign)","content":"Hello World"}' "http://localhost:8080/api/kms/verify"

```

# Misc

If you the SQS connection fails to connect because of some certificate issues (not configured),
you can disable certificate checking by starting Interlok with the java system property `-Dcom.amazonaws.sdk.disableCertChecking`


